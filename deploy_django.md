# Деплой проекта на Джанго
`Gunicorn` + `Nginx` + `PostgreSQL`

 - [Первоначальная настройка](#первоначальная-настройка)
 - [Установка основных пакетов](#установка-основных-пакетов)
 - [Настройка GIT и клонирование проекта](#настройка-git-и-клонирование-проекта)
 - [Установка и настройка PostgreSQL](#установка-и-настройка-postgresql)
 - [Установка виртуального окружения и установка зависимостей](#установка-виртуального-окружения-и-установка-зависимостей)
 - [Настройка проекта](#настройка-проекта)
 - [Установка Gunicorn и настройка демона systemd](#установка-gunicorn-и-настройка-демона-systemd)
 - [Установка и настройка Nginx](#установка-и-настройка-nginx)
 - [Получение и настройка SSL-сертификата](#получение-и-настройка-ssl-сертификата)
 - [Полезные команды](#полезные-команды)
 - [Полезные ссылки](#полезные-ссылки)

## Первоначальная настройка

Обновите индекс пакетов APT

```bash
sudo apt update
```

Теперь обновите установленные в системе пакеты и установите обновления безопасности

```
sudo apt upgrade
```

Для проверки настроек локализации введите команду:

```bash
locale 
```

Команда выдаст примерно такой результат:

```bash
LANG=en_US.UTF-8
LANGUAGE=
LC_CTYPE="en_US.UTF-8"
LC_NUMERIC="en_US.UTF-8"
LC_TIME="en_US.UTF-8"
LC_COLLATE="en_US.UTF-8"
LC_MONETARY="en_US.UTF-8"
... 
```

Чтобы работать с данными на русском языке, значением переменных `LC_CTYPE` и `LC_COLLATE` должно быть `ru_RU.UTF-8`. Если ваш сервер настроен иначе — установите русскую локализацию с помощью встроенной утилиты dpkg-reconfigure:

```bash
sudo dpkg-reconfigure locales 
```

В открывшемся интерфейсе найдите локаль `ru_RU.UTF-8` и отметьте её, нажав пробел.

В следующем окне укажите локаль по умолчанию: выберите `ru_RU.UTF-8`

Теперь перезапустите сервер:

```bash
sudo reboot 
```

Ещё раз проверьте настройки локализации:

```bash
locale 
```
Если вы видите `ru_RU.UTF-8`  — значит, всё получилось.

## Установка основных пакетов

Установка менеджера пакетов `pip`, утилиты для создания виртуального окружения `venv` и системы контроля версий `git`

```bash
sudo apt install python3-pip python3-venv git
```

Если если установленная в системе версия `Python` отличается от требуемой для проекта - установить нужную версию `Python`, например 3.7:

```bash
sudo apt install software-properties-common -y
sudo add-apt-repository ppa:deadsnakes/ppa -y
sudo apt update
sudo apt install python3.7  # указать нужную версию 
```

## Настройка GIT и клонирование проекта

Для клонировани приватного репозитория создайте SSH ключи:

```bash
ssh-keygen
```

Выведите ключ в терминал командой:

```bash
cat .ssh/id_rsa.pub
```

Скопируйте ключ, зайдите в свой аккаунт на GitHub и добавтьте ключ к аккаунту.

В настройках укажите своё имя и действующий адрес электронной почты.

```bash
git config --global user.name "Стас Басов"
git config --global user.email "stas.basov@whatever.com" 
```

Клонируйте проект с GitHub

```bash
git clone git@github.com:аккаунт-на-гитхабе/название-поекта.git
```

## Установка и настройка PostgreSQL

Обновите индекс пакетов APT и установите необходимые для работы PostgreSQL пакеты

```bash
sudo apt install postgresql postgresql-contrib
```

Чтобы проверить, что установка прошла успешно, запустите такую команду:

```bash
sudo -u postgres psql -c 'select now()'
```

От имени пользователя postgres вызовите утилиту psql

```bash
sudo -u postgres psql
```

Теперь через psql создайте базу данных с именем <имя_бд>:

```bash
CREATE DATABASE <имя_бд>;
# При успешном создании вернется CREATE DATABASE 
```

На сервере БД создайте регистрационную запись пользователя и дайте пользователю ему все права при работе с базой:

```bash
CREATE USER <имя_пользователя> WITH ENCRYPTED PASSWORD '<пароль>';
GRANT ALL PRIVILEGES ON DATABASE <имя_бд> TO <имя_пользователя>;   
```

Несколько полезных команд psql:

```bash
\?                # Справка по командам psql
\h                # Справка по доступным командам SQL
\h <команда>      # Справка по конкретной команде
\l                # Список баз
\du               # Список пользователей
\connect db_name  # Подключиться к базе с именем db_name
\dt               # Список таблиц
\q                # Выход с программы
```

Создать резервные копии (дамп) данных в файл backup.dump:

```bash
sudo -u postgres pg_dump <имя_бд> > backup.dump 
```

Чтобы восстановить их, нужно создать пустую базу данных (называйте её как-то иначе, нежели основную) и загрузить в неё данные из резервной копии. Выполните команды:

```bash
sudo -u postgres psql -c 'create database <новая_бд>;'
sudo -u postgres psql -d <новая_бд> -f backup.dump
```

## Установка виртуального окружения и установка зависимостей

Перейти в папку с проектом:

```bash
cd ./название-поекта
```

Создать виртуальное окружение указав нужную версию `Python`:

```bash
python3.7 -m venv .venv

#  Или используя системную версию Python
python3 -m venv .venv
```

Активировать виртуальное окружение:

```bash
sourсe .venv/bin/activate
```

Установка зависмостей:

```bash
# Установка основных зависимостей проекта
pip install -r requirements.txt

# При необходимости установить
pip install psycopg2-binary  # Драйвер PostgeSQL
pip install gunicorn         # Gunicorn
```

## Настройка проекта

Проверить, что активировано виртуальное окружение. Если нет:

```bash
sourсe .venv/bin/activate
```

В файле настроек проекта (по умолчанию settings.py)

```python
# Установить значение константы DEBUG
DEBUG = False

# Добавить в ALLOWED_HOSTS ip и доменное имя сервера
ALLOWED_HOSTS = ['xxx.xxx.xxx.xxx', 'example.com', '127.0.0.1', 'localhost']

# В константе DATABASES указать параметры подлкючения к базе данных, например:
DATABASES = {
    'default': {
        'ENGINE': os.getenv('DB_ENGINE', 'django.db.backends.postgresql'),
        'NAME': os.getenv('DB_NAME'),
        'USER': os.getenv('POSTGRES_USER'),
        'PASSWORD': os.getenv('POSTGRES_PASSWORD'),
        'HOST': os.getenv('DB_HOST'),
        'PORT': os.getenv('DB_PORT')
    }
}

# Проверить, что указано значение контстаны STATIC_ROOT
STATIC_ROOT = os.path.join(BASE_DIR, 'static/')
# или (если Django>=3.2)
STATIC_ROOT = BASE_DIR / 'static/'
```

Выполнить миграции:

```bash
python3 manage.py migrate
```

Собрать статику:

```bash
python3 manage.py collectstatic
```

При необходимости создать суперпользователя

```bash
python3 manage.py createsuperuser
```

Провеить, что всё работает:

```bash
python3 manage.py runserver 0:8000
```

## Установка Gunicorn и настройка демона systemd

Проверить, что активировано виртуальное окружение. Если нет:

```bash
sourсe .venv/bin/activate
```

Узнать путь до gunicorn:
```bash
which gunicorn

# Если gunicorn не установлен
pip install gunicorn
```

Протестировать gunicorn:

```bash
gunicorn --bind 0.0.0.0:8000 <папка_с_wsgi.py>.wsgi
```

В директории /etc/systemd/system/ создайте файл gunicorn.service и откройте его:

```bash
sudo vim /etc/systemd/system/gunicorn.service 
```

В этом файле опишите конфигурацию юнита:
```bash
[Unit]
# это текстовое описание юнита, пояснение для разработчика
Description=gunicorn daemon 

# при старте операционной системы запускать процесс только после того, 
# как операционная система загрузится и настроит подключение к сети
After=network.target 

[Service]
# от чьего имени запускать процесс:
# укажите имя, под которым вы подключались к серверу
User=<имя-пользователя-в-системе> 

# адрес к директории, где установлен Gunicorn
WorkingDirectory=/home/<имя-пользователя-в-системе>/
<директория-с-проектом>/<директория-с-файлом-manage.py>/ 

# команду, которую вы запускали руками, теперь будет запускать systemd:
# в указанной директории будет выполнена команда bind
# и по запросу к 127.0.0.1:8000 будет выполнен файл запуска приложения yatube.wsgi
ExecStart=/home/<имя-пользователя-в-системе>/
<директория-с-проектом>/<путь-до-gunicorn-в-виртуальном-окружении> --bind 127.0.0.1:8000 <папка_с_wsgi.py>.wsgi:application

[Install]
# группировка юнитов 
WantedBy=multi-user.target
```

Запустить юнит gunicorn и проверить его статус:

```bash
sudo systemctl start gunicorn 
sudo systemctl enable gunicorn
```

Если всё хорошо,  добавить юнит в список автозапуска:

```bash
sudo systemctl enable gunicorn
```

В случае каких-либо изменения в исходном коде проекта, не забыть перезапустить юнит

```bash
sudo systemctl restart gunicorn
```

## Установка и настройка Nginx

Установить Nginx:

```bash
sudo apt install nginx
```

Настроить и включить фаервол:

```bash
sudo ufw allow 'Nginx Full'
sudo ufw allow OpenSSH
sudo ufw enable

# Проверьте внесённые изменения
sudo ufw status
```

Измените стандартный конфигурационный файл nginx:

```bash
sudo vim /etc/nginx/sites-enabled/default
```

В файле конфигурации nginx удалить код для стандартных конфигураций, вместо него добавить:

```bash
server {
    listen 80;
    server_name <ваш-ip> <доменное-имя>;

    # статика
    location /static/ {
        root /home/<имя_пользователя>/<название_проекта>/<папка_где_manage.py>/;
    }
        
    # медиа файлы
    location /media/ {
        root /home/<имя_пользователя>/<название_проекта>/<папка_где_manage.py>/;
    }

    # любой другой запрос передай серверу Gunicorn
    location / {
        include proxy_params;
        # передавать запросы нужно на внутренний IP на порт 8000
        proxy_pass http://127.0.0.1:8000;
    }
}
```

Протестируйте работоспособность новой конфигурации — нет ли синтаксических ошибок в конфиге:

```bash
sudo nginx -t
```

Если всё хорошо, перезапустите nginx:

```bash
sudo systemctl reload nginx 
```

## Получение и настройка SSL-сертификата

Установите менеджер пакетов snap:

```bash
sudo apt install snapd
sudo snap install core; sudo snap refresh core
```

Установите certbot и создайте симфольную ссылку:

```bash
sudo snap install --classic certbot
sudo ln -s /snap/bin/certbot /usr/bin/certbot 
```

Чтобы начать процесс получения сертификата, введите команду:

```bash
sudo certbot --nginx
```

В процессе оформления сертификата вам нужно будет указать свою электронную почту и ответить на несколько вопросов.
 - “Enter email address” (англ. «введите почту»). Почта нужна для предупреждений, что сертификат пора обновить.
 - “Please read the Terms of Service...” (англ. «прочитайте правила сервиса»). Прочитайте правила по ссылке, введите y и нажмите Enter.
 - “Would you be willing to share your email address with the Electronic Frontier Foundation?” (англ. «хотите ли вы поделиться своей почтой с Фондом электронных рубежей»). Отметьте на своё усмотрение y (да) или n (нет) и нажмите Enter.
 - “Please enter the domain name(s) you would like on your certificate” (англ. «пожалуйста, введите доменные имена, которые вы хотели бы видеть в своем сертификате»). Введите добавленное в проект доменное имя, нажмите Enter.

Перезапустите nginx:

```bash
sudo systemctl reload nginx
```

Ручное обновление сертификата:

```bash
sudo certbot renew --pre-hook "service nginx stop" --post-hook "service nginx start"
```

## Полезные команды

Работа с пользователями и группами:

```bash
sudo useradd <имя-пользователя>  # Создать пользователя

sudo passwd <имя-пользователя>  # Изменить пароль для пользователя

sudo groupadd <имя-группы>  # Создать группу

sudo usermod -aG <имя-группы> <имя-пользователя>  #  Добавить пользователя в группу

sudo usermod -aG sudo <имя-пользователя>  # Дать пользователю привилегии суперпользователя
```

Посмотреть права на файлы и папки:

```bash
ls -l
```

Пример вывода в консоль:

```bash
-rwxrw-r-- 1 file.txt    115 июл 12 17:04 file
```

Первый символ в строке — это `-`, значит, вы сейчас смотрите на права доступа к файлу. Если бы речь шла о директории, то первым символом была бы буква `d`.

Далее идут девять символов, это три группы по три символа: 
 - первая группа из трёх символов — это права доступа для владельца файла;
 - вторая — права для группы;
 - третья — права доступа для всех остальных пользователей.

Права определяются символами:
 - r (от англ. read ) — разрешено чтение и просмотр;
 - w (от англ. write) — разрешено записывать и изменять файл;
 - x (от англ. execute) — разрешено запускать и исполнять файл.

Описывать права доступа можно не только буквами и символами -, но и числами. Права записываются группой из трёх цифр: первая цифра определяет права для владельца, вторая — для пользователей его группы, третья — для всех прочих пользователей.

Права определяются цифрами от 0 до 7:
 - 0 — нет прав (соответствует ---);
 - 1 — только выполнение (соответствует --x);
 - 2 — только запись (соответствует -w-);
 - 3 — запись и выполнение (соответствует -wx);
 - 4 — только чтение (соответствует r--);
 - 5 — чтение и выполнение (соответствует r-x);
 - 6 — чтение и запись (соответствует rw-);
 - 7 — все права (соответствует rwx).


Изменение прав доступа к файлу или папке:

```bash
chgrp <имя-группы> <путь-к-папке-или-файлу>  # Изменить группу

chmod -R 775 <путь-к-папке>  # Изменить права папки на 775

chmod 775 <путь-к-файлу>  # Изменить права файла на 775
```

## Полезные ссылки

[Документация](https://postgrespro.ru/docs/postgresql/12/) PostgreSQL на русском языке.

Бесплатные домены [NoIP](http://www.noip.com/)

Бесплатные домены [co.vu](https://codotvu.co/)

Официальный сайт [certbot](https://certbot.eff.org/)
Сервис мониторинга [UptimeRobot](https://uptimerobot.com/)

Мониторит ошибки веб-приложений [Sentry](https://sentry.io/)
